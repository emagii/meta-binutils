From 3cf70e8413027288b6cb0e22a603662acd856802 Mon Sep 17 00:00:00 2001
From: Ulf Samuelsson <binutils@emagii.com>
Date: Thu, 16 Feb 2023 18:14:37 +0100
Subject: [PATCH 08/13] ldgram.y: CRC64

Signed-off-by: Ulf Samuelsson <binutils@emagii.com>
---
 ld/ldgram.y | 78 ++++++++++++++++++++++++++++++++++++++++++++++++++++-
 1 file changed, 77 insertions(+), 1 deletion(-)

diff --git a/ld/ldgram.y b/ld/ldgram.y
index daad73c1..290d0b65 100644
--- a/ld/ldgram.y
+++ b/ld/ldgram.y
@@ -41,6 +41,7 @@
 #include "mri.h"
 #include "ldctor.h"
 #include "ldlex.h"
+#include "checksum.h"
 
 #ifndef YYDEBUG
 #define YYDEBUG 1
@@ -129,6 +130,9 @@ static int error_index;
 %token DATA_SEGMENT_ALIGN DATA_SEGMENT_RELRO_END DATA_SEGMENT_END
 %token SORT_BY_NAME SORT_BY_ALIGNMENT SORT_NONE
 %token SORT_BY_INIT_PRIORITY
+%token CRC64 CRC32 ECMA ISO POLY POLYI TABLE
+%token TIMESTAMP
+%token DEBUG ON OFF
 %token '{' '}'
 %token SIZEOF_HEADERS OUTPUT_FORMAT FORCE_COMMON_ALLOCATION OUTPUT_ARCH
 %token INHIBIT_COMMON_ALLOCATION FORCE_GROUP_ALLOCATION
@@ -666,7 +670,7 @@ statement:
 		{
 		  lang_add_data ((int) $1, $3);
 		}
-        | ASCII '(' mustbe_exp ')' NAME
+	| ASCII '(' mustbe_exp ')' NAME
 		{
 		  /* 'value' is a memory leak, do we care?  */
 		  etree_type *value = $3;
@@ -680,6 +684,38 @@ statement:
 		{
 		  lang_add_fill ($3);
 		}
+	| CRC32
+		{
+		  lang_add_assignment (exp_assign (CRC32_ADDRESS, exp_nameop (NAME,"."), false));
+		}
+		polynome32 '(' mustbe_exp ',' mustbe_exp ')'
+		{
+		  lang_add_assignment (exp_assign (CRC32_START, $5, false));
+		  lang_add_assignment (exp_assign (CRC32_END,   $7, false));
+		}
+	| CRC32 TABLE
+		{
+		  lang_add_assignment (exp_assign (CRC32_TABLE, exp_nameop (NAME,"."), false));
+		  lang_add_crc32_table ();
+		}
+	| CRC64
+		{
+		  lang_add_assignment (exp_assign (CRC64_ADDRESS, exp_nameop (NAME,"."), false));
+		}
+		polynome64 '(' mustbe_exp ',' mustbe_exp ')'
+		{
+		  lang_add_assignment (exp_assign (CRC64_START, $5, false));
+		  lang_add_assignment (exp_assign (CRC64_END,   $7, false));
+		}
+	| CRC64 TABLE
+		{
+		  lang_add_assignment (exp_assign (CRC64_TABLE, exp_nameop (NAME,"."), false));
+		  lang_add_crc64_table ();
+		}
+	| TIMESTAMP
+		{
+		  lang_add_timestamp ();
+		}
 	| ASSERT_K
 		{ ldlex_expression (); }
 	  '(' exp ',' NAME ')' separator
@@ -691,9 +727,49 @@ statement:
 		{
 		  ldfile_open_command_file ($2);
 		}
+	| DEBUG ON
+		{
+		  yydebug = 1;
+		}
+	| DEBUG OFF
+		{
+		  yydebug = 0;
+		}
 	  statement_list_opt END
 	;
 
+polynome64:
+	ECMA
+		{
+		  lang_add_crc64_syndrome (false, CRC_POLY_64);
+		}
+	| ISO
+		{
+		  lang_add_crc64_syndrome (false, CRC_POLY_64_ISO);
+		}
+	| POLY mustbe_exp
+		{
+		  lang_add_crc64_syndrome (false, $2->value.value);
+		}
+	| POLYI mustbe_exp
+		{
+		  lang_add_crc64_syndrome (true,  $2->value.value);
+		}
+
+polynome32:
+	CRC32
+		{
+		  lang_add_crc32_syndrome (true,  CRC_POLY_32);
+		}
+	| POLY mustbe_exp
+		{
+		  lang_add_crc32_syndrome (false, $2->value.value);
+		}
+	| POLYI mustbe_exp
+		{
+		  lang_add_crc32_syndrome (true,  $2->value.value);
+		}
+
 statement_list:
 		statement_list statement
 	|	statement
-- 
2.17.1

